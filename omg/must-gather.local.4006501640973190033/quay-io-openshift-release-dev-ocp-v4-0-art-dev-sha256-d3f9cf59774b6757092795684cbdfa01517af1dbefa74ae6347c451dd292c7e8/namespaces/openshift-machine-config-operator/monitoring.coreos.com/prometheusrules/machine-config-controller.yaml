---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    include.release.openshift.io/ibm-cloud-managed: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
    include.release.openshift.io/single-node-developer: "true"
  creationTimestamp: "2023-05-02T12:18:28Z"
  generation: 1
  labels:
    k8s-app: machine-config-controller
  managedFields:
  - apiVersion: monitoring.coreos.com/v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .: {}
          f:include.release.openshift.io/ibm-cloud-managed: {}
          f:include.release.openshift.io/self-managed-high-availability: {}
          f:include.release.openshift.io/single-node-developer: {}
        f:labels:
          .: {}
          f:k8s-app: {}
        f:ownerReferences:
          .: {}
          k:{"uid":"77d6ad13-e1ab-45f9-a3c3-540f5d841b6f"}: {}
      f:spec:
        .: {}
        f:groups: {}
    manager: cluster-version-operator
    operation: Update
    time: "2023-05-02T12:18:28Z"
  name: machine-config-controller
  namespace: openshift-machine-config-operator
  ownerReferences:
  - apiVersion: config.openshift.io/v1
    kind: ClusterVersion
    name: version
    uid: 77d6ad13-e1ab-45f9-a3c3-540f5d841b6f
  resourceVersion: "1648"
  uid: dc185650-a4c9-4337-b2e4-03315e4618a3
spec:
  groups:
  - name: mcc-paused-pool-kubelet-ca
    rules:
    - alert: MachineConfigControllerPausedPoolKubeletCA
      annotations:
        description: Machine config pools have a 'pause' feature, which allows config
          to be rendered, but prevents it from being rolled out to the nodes. This
          alert indicates that a certificate rotation has taken place, and the new
          kubelet-ca certificate bundle has been rendered into a machine config, but
          because the pool '{{$labels.pool}}' is paused, the config cannot be rolled
          out to the nodes in that pool. You will notice almost immediately that for
          nodes in pool '{{$labels.pool}}', pod logs will not be visible in the console
          and interactive commands (oc log, oc exec, oc debug, oc attach) will not
          work. You must unpause machine config pool '{{$labels.pool}}' to let the
          certificates through before the kube-apiserver-to-kubelet-signer certificate
          expires on {{ $value | humanizeTimestamp }} or this pool's nodes will cease
          to function properly.
        runbook_url: https://github.com/openshift/blob/master/alerts/machine-config-operator/MachineConfigControllerPausedPoolKubeletCA.md
        summary: Paused machine configuration pool '{{$labels.pool}}' is blocking
          a necessary certificate rotation and must be unpaused before the current
          kube-apiserver-to-kubelet-signer certificate expires on {{ $value | humanizeTimestamp
          }}.
      expr: |
        max by (namespace,pool) (last_over_time(machine_config_controller_paused_pool_kubelet_ca[5m])) > 0
      for: 60m
      labels:
        severity: warning
    - alert: MachineConfigControllerPausedPoolKubeletCA
      annotations:
        description: Machine config pools have a 'pause' feature, which allows config
          to be rendered, but prevents it from being rolled out to the nodes. This
          alert indicates that a certificate rotation has taken place, and the new
          kubelet-ca certificate bundle has been rendered into a machine config, but
          because the pool '{{$labels.pool}}' is paused, the config cannot be rolled
          out to the nodes in that pool. You will notice almost immediately that for
          nodes in pool '{{$labels.pool}}', pod logs will not be visible in the console
          and interactive commands (oc log, oc exec, oc debug, oc attach) will not
          work. You must unpause machine config pool '{{$labels.pool}}' to let the
          certificates through before the kube-apiserver-to-kubelet-signer certificate
          expires. You have approximately {{ $value | humanizeDuration }} remaining
          before this happens and nodes in '{{$labels.pool}}' cease to function properly.
        runbook_url: https://github.com/openshift/blob/master/alerts/machine-config-operator/MachineConfigControllerPausedPoolKubeletCA.md
        summary: Paused machine configuration pool '{{$labels.pool}}' is blocking
          a necessary certificate rotation and must be unpaused before the current
          kube-apiserver-to-kubelet-signer certificate expires in {{ $value | humanizeDuration
          }}.
      expr: |
        max by (namespace,pool) (last_over_time(machine_config_controller_paused_pool_kubelet_ca[5m]) - time()) < (86400 * 14) AND max by (namespace,pool) (last_over_time(machine_config_controller_paused_pool_kubelet_ca[5m])) > 0
      for: 60m
      labels:
        severity: critical
  - name: os-image-override.rules
    rules:
    - expr: sum(os_image_url_override)
      record: os_image_url_override:sum
